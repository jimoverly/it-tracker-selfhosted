<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IT Integration Tracker</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        *{margin:0;padding:0;box-sizing:border-box}
        body{font-family:'Inter',sans-serif;min-height:100vh;transition:background 0.3s,color 0.3s}
        body.light{background:linear-gradient(135deg,#f5f7fa 0%,#e4e8ec 100%);color:#2d3748}
        body.dark{background:#0f0f0f;color:#e4e4e7}
        input:focus,select:focus,textarea:focus{outline:none}
        button:hover:not(:disabled){transform:translateY(-1px)}
        button:disabled{opacity:0.5;cursor:not-allowed}
    </style>
</head>
<body class="light">
<div id="root"></div>
<script type="text/babel">
const {useState,useEffect,createContext,useContext}=React;
const AuthContext=createContext(null);
const ThemeContext=createContext(null);
const useAuth=()=>useContext(AuthContext);
const useTheme=()=>useContext(ThemeContext);

const themes={
    light:{name:'light',bg:'#ffffff',bgAlt:'#f7fafc',card:'#ffffff',cardBorder:'#e2e8f0',text:'#2d3748',textMuted:'#718096',accent:'#1a5276',accentLight:'#2c5282',teal:'#008b8b',input:'#ffffff',inputBorder:'#e2e8f0',headerBorder:'#1a5276',modalOverlay:'rgba(0,0,0,0.5)',shadow:'rgba(0,0,0,0.08)',progressBg:'#e2e8f0',overdueBg:'#fffaf0',overdueText:'#c05621',status:{'Not Started':{bg:'#e2e8f0',text:'#718096'},'In Progress':{bg:'#bee3f8',text:'#2b6cb0'},'Complete':{bg:'#c6f6d5',text:'#276749'},'Blocked':{bg:'#fed7d7',text:'#c53030'},'On Hold':{bg:'#feebc8',text:'#c05621'}},priority:{'Critical':{bg:'#fed7e2',text:'#b83280'},'High':{bg:'#fed7d7',text:'#c53030'},'Medium':{bg:'#feebc8',text:'#c05621'},'Low':{bg:'#bee3f8',text:'#2b6cb0'}},role:{admin:{bg:'#fed7e2',text:'#b83280'},teamlead:{bg:'#e9d8fd',text:'#6b46c1'},edit:{bg:'#bee3f8',text:'#2b6cb0'},readonly:{bg:'#e2e8f0',text:'#718096'}}},
    dark:{name:'dark',bg:'#0f0f0f',bgAlt:'#1a1a1a',card:'#1a1a1a',cardBorder:'#2a2a2a',text:'#e4e4e7',textMuted:'#71717a',accent:'#00d4aa',accentLight:'#00a896',teal:'#00d4aa',input:'#0f0f0f',inputBorder:'#2a2a2a',headerBorder:'#2a2a2a',modalOverlay:'rgba(0,0,0,0.8)',shadow:'rgba(0,212,170,0.1)',progressBg:'#2a2a2a',overdueBg:'rgba(251,146,60,0.1)',overdueText:'#fb923c',status:{'Not Started':{bg:'rgba(113,113,122,0.2)',text:'#a1a1aa'},'In Progress':{bg:'rgba(59,130,246,0.2)',text:'#60a5fa'},'Complete':{bg:'rgba(34,197,94,0.2)',text:'#4ade80'},'Blocked':{bg:'rgba(239,68,68,0.2)',text:'#f87171'},'On Hold':{bg:'rgba(251,146,60,0.2)',text:'#fb923c'}},priority:{'Critical':{bg:'rgba(236,72,153,0.2)',text:'#f472b6'},'High':{bg:'rgba(239,68,68,0.2)',text:'#f87171'},'Medium':{bg:'rgba(251,146,60,0.2)',text:'#fb923c'},'Low':{bg:'rgba(59,130,246,0.2)',text:'#60a5fa'}},role:{admin:{bg:'rgba(236,72,153,0.2)',text:'#f472b6'},teamlead:{bg:'rgba(168,85,247,0.2)',text:'#c084fc'},edit:{bg:'rgba(59,130,246,0.2)',text:'#60a5fa'},readonly:{bg:'rgba(113,113,122,0.2)',text:'#a1a1aa'}}}
};
const wsColors={'Office 365':'#0078d4','Network':'#38a169','Cybersecurity':'#e53e3e','Active Directory':'#805ad5','Applications':'#dd6b20','Communications':'#319795','Human Resources':'#d53f8c','Custom':'#718096'};

function getCSS(t){return{header:{background:t.name==='dark'?'linear-gradient(180deg,#1a1a1a,#0f0f0f)':t.card,borderBottom:t.name==='dark'?'1px solid '+t.cardBorder:'3px solid '+t.headerBorder,padding:'12px 32px',position:'sticky',top:0,zIndex:100},card:{background:t.card,borderRadius:'12px',border:'1px solid '+t.cardBorder,padding:'20px',marginBottom:'16px'},input:{background:t.input,border:'2px solid '+t.inputBorder,borderRadius:'8px',padding:'10px 14px',fontSize:'14px',width:'100%',color:t.text},select:{background:t.input,border:'2px solid '+t.inputBorder,borderRadius:'8px',padding:'10px 14px',fontSize:'14px',cursor:'pointer',color:t.text},btn:{padding:'10px 20px',border:'none',borderRadius:'8px',cursor:'pointer',fontSize:'14px',fontWeight:'600'},btnPri:{background:'linear-gradient(135deg,'+t.accent+','+t.accentLight+')',color:t.name==='dark'?'#0f0f0f':'#fff'},btnSec:{background:t.card,color:t.accent,border:'2px solid '+t.accent},btnDanger:{background:t.card,color:'#f87171',border:'2px solid #7f1d1d'},btnSuccess:{background:t.card,color:t.name==='dark'?'#4ade80':'#276749',border:'2px solid '+(t.name==='dark'?'#166534':'#48bb78')},modal:{position:'fixed',top:0,left:0,right:0,bottom:0,background:t.modalOverlay,display:'flex',alignItems:'center',justifyContent:'center',zIndex:1000},modalBox:{background:t.card,borderRadius:'16px',padding:'28px',width:'90%',maxWidth:'600px',maxHeight:'90vh',overflow:'auto',border:'1px solid '+t.cardBorder},label:{display:'block',fontSize:'12px',color:t.accent,marginBottom:'6px',fontWeight:'600',textTransform:'uppercase'}}}

const api={token:localStorage.getItem('token'),async fetch(url,opts={}){const res=await fetch(url,{...opts,headers:{...opts.headers,'Content-Type':'application/json','Authorization':'Bearer '+this.token}});if(res.status===401){localStorage.removeItem('token');window.location.reload()}return res},get:url=>api.fetch(url).then(r=>r.json()),post:(url,data)=>api.fetch(url,{method:'POST',body:JSON.stringify(data)}).then(r=>r.json()),put:(url,data)=>api.fetch(url,{method:'PUT',body:JSON.stringify(data)}).then(r=>r.json()),del:url=>api.fetch(url,{method:'DELETE'}).then(r=>r.json()),upload:async(url,file)=>{const fd=new FormData();fd.append('file',file);return fetch(url,{method:'POST',headers:{'Authorization':'Bearer '+api.token},body:fd}).then(r=>r.json())}};

function Badge({text,colors}){return <span style={{display:'inline-block',padding:'4px 12px',borderRadius:'20px',fontSize:'11px',fontWeight:'600',background:colors?.bg||'#e2e8f0',color:colors?.text||'#718096'}}>{text}</span>}
function Progress({value,color='#1a5276'}){const{theme}=useTheme();return <div style={{width:'100%',height:'8px',background:theme.progressBg,borderRadius:'4px'}}><div style={{height:'100%',width:value+'%',background:color,borderRadius:'4px'}}/></div>}
function ThemeToggle(){const{theme,toggleTheme}=useTheme();return <button onClick={toggleTheme} style={{background:theme.card,border:'1px solid '+theme.cardBorder,borderRadius:'8px',padding:'8px 12px',cursor:'pointer',fontSize:'16px'}} title={'Switch to '+(theme.name==='light'?'dark':'light')+' mode'}>{theme.name==='light'?'ğŸŒ™':'â˜€ï¸'}</button>}

function exportToExcel(data){const wb=XLSX.utils.book_new();const ov=[['Project Export'],[''],['Project:',data.project.name],['Acquired:',data.project.acquired_company],['Parent:',data.project.parent_company],['Status:',data.project.status],[''],['WORKSTREAM SUMMARY'],['Workstream','Total','Not Started','In Progress','Complete','Blocked','Progress']];data.workstreamStats.forEach(ws=>ov.push([ws.workstream,ws.total,ws.notStarted,ws.inProgress,ws.complete,ws.blocked,ws.progress+'%']));XLSX.utils.book_append_sheet(wb,XLSX.utils.aoa_to_sheet(ov),'Overview');XLSX.utils.book_append_sheet(wb,XLSX.utils.aoa_to_sheet([['ID','Workstream','Task','Description','Owner','Priority','Status','Start','Due','%','Dependencies','Notes'],...data.tasks.map(t=>[t.id,t.workstream,t.name,t.description,t.owner,t.priority,t.status,t.start_date,t.due_date,t.percent_complete,t.dependencies,t.notes])]),'Tasks');XLSX.utils.book_append_sheet(wb,XLSX.utils.aoa_to_sheet([['Name','Role','Company','Workstream','Email','Phone'],...data.contacts.map(c=>[c.name,c.role,c.company,c.workstream,c.email,c.phone])]),'Contacts');XLSX.utils.book_append_sheet(wb,XLSX.utils.aoa_to_sheet([['ID','Description','Workstream','Likelihood','Impact','Mitigation','Owner'],...data.risks.map(r=>[r.id,r.description,r.workstream,r.likelihood,r.impact,r.mitigation,r.owner])]),'Risks');XLSX.writeFile(wb,data.project.name.replace(/[^a-z0-9]/gi,'_')+'_Export.xlsx')}

function LoginScreen({onLogin}){const{theme}=useTheme();const css=getCSS(theme);const [u,setU]=useState('');const [p,setP]=useState('');const [err,setErr]=useState('');const [loading,setLoading]=useState(false);const submit=async e=>{e.preventDefault();setErr('');setLoading(true);try{const res=await fetch('/api/auth/login',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({username:u,password:p})});const data=await res.json();if(!res.ok)throw new Error(data.error);localStorage.setItem('token',data.token);api.token=data.token;onLogin(data.user)}catch(e){setErr(e.message)}setLoading(false)};return <div style={{minHeight:'100vh',display:'flex',alignItems:'center',justifyContent:'center',background:'linear-gradient(135deg,'+theme.accent+','+theme.accentLight+')'}}><div style={{...css.card,width:'100%',maxWidth:'400px',padding:'40px'}}><div style={{textAlign:'center',marginBottom:'32px'}}><img src="/logo.jpg" style={{maxWidth:'250px',marginBottom:'20px',filter:theme.name==='dark'?'brightness(1.1)':'none'}}/><h1 style={{fontSize:'20px',color:theme.accent}}>IT Integration Tracker</h1></div><form onSubmit={submit}><div style={{marginBottom:'16px'}}><label style={css.label}>Username</label><input style={css.input} value={u} onChange={e=>setU(e.target.value)}/></div><div style={{marginBottom:'24px'}}><label style={css.label}>Password</label><input type="password" style={css.input} value={p} onChange={e=>setP(e.target.value)}/></div>{err&&<div style={{background:theme.status.Blocked.bg,padding:'12px',borderRadius:'8px',marginBottom:'16px',color:theme.status.Blocked.text,fontSize:'13px'}}>{err}</div>}<button type="submit" disabled={loading} style={{...css.btn,...css.btnPri,width:'100%'}}>{loading?'Signing in...':'Sign In'}</button></form><p style={{textAlign:'center',marginTop:'20px',fontSize:'12px',color:theme.textMuted}}>Contact your administrator for credentials</p><div style={{textAlign:'center',marginTop:'16px'}}><ThemeToggle/></div></div></div>}

function UserManagement(){const{theme}=useTheme();const css=getCSS(theme);const{user}=useAuth();const [users,setUsers]=useState([]);const [showAdd,setShowAdd]=useState(false);const [editUser,setEditUser]=useState(null);const [form,setForm]=useState({username:'',password:'',display_name:'',email:'',role:'readonly'});useEffect(()=>{load()},[]);const load=()=>api.get('/api/users').then(setUsers);const add=async()=>{if(!form.username||!form.password)return alert('Required');await api.post('/api/users',form);setForm({username:'',password:'',display_name:'',email:'',role:'readonly'});setShowAdd(false);load()};const edit=async()=>{await api.put('/api/users/'+editUser.id,editUser);setEditUser(null);load()};const resetPw=async id=>{const pw=prompt('New password:');if(pw){await api.post('/api/users/'+id+'/reset-password',{newPassword:pw});alert('Done')}};const del=async id=>{if(confirm('Delete?')){await api.del('/api/users/'+id);load()}};return <div style={{padding:'20px 32px',maxWidth:'1200px',margin:'0 auto'}}><div style={{display:'flex',justifyContent:'space-between',marginBottom:'24px'}}><h1 style={{fontSize:'24px',color:theme.accent}}>User Management</h1><button style={{...css.btn,...css.btnPri}} onClick={()=>setShowAdd(true)}>+ Add User</button></div><div style={css.card}><table style={{width:'100%',borderCollapse:'collapse'}}><thead><tr>{['User','Email','Role','Status','Actions'].map(h=><th key={h} style={{textAlign:'left',padding:'12px',fontSize:'12px',color:theme.accent,borderBottom:'2px solid '+theme.cardBorder}}>{h}</th>)}</tr></thead><tbody>{users.map(u=><tr key={u.id} style={{borderBottom:'1px solid '+theme.cardBorder}}><td style={{padding:'14px'}}><strong style={{color:theme.text}}>{u.display_name||u.username}</strong><div style={{fontSize:'12px',color:theme.textMuted}}>@{u.username}</div></td><td style={{padding:'14px',color:theme.textMuted}}>{u.email||'â€”'}</td><td style={{padding:'14px'}}><Badge text={u.role} colors={theme.role[u.role]}/></td><td style={{padding:'14px'}}><Badge text={u.active?'Active':'Disabled'} colors={u.active?theme.status.Complete:theme.status.Blocked}/></td><td style={{padding:'14px'}}><button style={{...css.btn,...css.btnSec,padding:'6px 12px',fontSize:'12px',marginRight:'6px'}} onClick={()=>setEditUser({...u})}>Edit</button><button style={{...css.btn,...css.btnSec,padding:'6px 12px',fontSize:'12px',marginRight:'6px'}} onClick={()=>resetPw(u.id)}>Reset</button>{u.id!==user.id&&<button style={{...css.btn,...css.btnDanger,padding:'6px 12px',fontSize:'12px'}} onClick={()=>del(u.id)}>Del</button>}</td></tr>)}</tbody></table></div>{showAdd&&<div style={css.modal} onClick={()=>setShowAdd(false)}><div style={css.modalBox} onClick={e=>e.stopPropagation()}><h2 style={{color:theme.accent,marginBottom:'20px'}}>Add User</h2><div style={{marginBottom:'14px'}}><label style={css.label}>Username *</label><input style={css.input} value={form.username} onChange={e=>setForm({...form,username:e.target.value})}/></div><div style={{marginBottom:'14px'}}><label style={css.label}>Password *</label><input type="password" style={css.input} value={form.password} onChange={e=>setForm({...form,password:e.target.value})}/></div><div style={{marginBottom:'14px'}}><label style={css.label}>Display Name</label><input style={css.input} value={form.display_name} onChange={e=>setForm({...form,display_name:e.target.value})}/></div><div style={{marginBottom:'14px'}}><label style={css.label}>Email</label><input style={css.input} value={form.email} onChange={e=>setForm({...form,email:e.target.value})}/></div><div style={{marginBottom:'20px'}}><label style={css.label}>Role</label><select style={{...css.select,width:'100%'}} value={form.role} onChange={e=>setForm({...form,role:e.target.value})}><option value="readonly">Read Only</option><option value="edit">Edit</option><option value="teamlead">Team Lead</option><option value="admin">Admin</option></select></div><div style={{display:'flex',gap:'12px',justifyContent:'flex-end'}}><button style={{...css.btn,...css.btnSec}} onClick={()=>setShowAdd(false)}>Cancel</button><button style={{...css.btn,...css.btnPri}} onClick={add}>Create</button></div></div></div>}{editUser&&<div style={css.modal} onClick={()=>setEditUser(null)}><div style={css.modalBox} onClick={e=>e.stopPropagation()}><h2 style={{color:theme.accent,marginBottom:'20px'}}>Edit: {editUser.username}</h2><div style={{marginBottom:'14px'}}><label style={css.label}>Display Name</label><input style={css.input} value={editUser.display_name||''} onChange={e=>setEditUser({...editUser,display_name:e.target.value})}/></div><div style={{marginBottom:'14px'}}><label style={css.label}>Email</label><input style={css.input} value={editUser.email||''} onChange={e=>setEditUser({...editUser,email:e.target.value})}/></div><div style={{marginBottom:'14px'}}><label style={css.label}>Role</label><select style={{...css.select,width:'100%'}} value={editUser.role} onChange={e=>setEditUser({...editUser,role:e.target.value})} disabled={editUser.id===user.id}><option value="readonly">Read Only</option><option value="edit">Edit</option><option value="teamlead">Team Lead</option><option value="admin">Admin</option></select></div><div style={{marginBottom:'20px'}}><label style={{color:theme.text}}><input type="checkbox" checked={editUser.active} onChange={e=>setEditUser({...editUser,active:e.target.checked})}/> Active</label></div><div style={{display:'flex',gap:'12px',justifyContent:'flex-end'}}><button style={{...css.btn,...css.btnSec}} onClick={()=>setEditUser(null)}>Cancel</button><button style={{...css.btn,...css.btnPri}} onClick={edit}>Save</button></div></div></div>}</div>}

function AdminTemplates(){const{theme}=useTheme();const css=getCSS(theme);const [tab,setTab]=useState('workstreams');const [workstreams,setWorkstreams]=useState([]);const [tasks,setTasks]=useState([]);const [showAddWs,setShowAddWs]=useState(false);const [wsForm,setWsForm]=useState({name:'',color:'#718096'});useEffect(()=>{load()},[]);const load=()=>{api.get('/api/admin/workstreams').then(setWorkstreams);api.get('/api/admin/default-tasks').then(setTasks)};return <div style={{padding:'20px 32px',maxWidth:'1400px',margin:'0 auto'}}><h1 style={{fontSize:'24px',color:theme.accent,marginBottom:'20px'}}>Template Management</h1><div style={{display:'flex',gap:'8px',marginBottom:'20px'}}><button style={{...css.btn,...(tab==='workstreams'?css.btnPri:css.btnSec)}} onClick={()=>setTab('workstreams')}>Workstreams</button><button style={{...css.btn,...(tab==='tasks'?css.btnPri:css.btnSec)}} onClick={()=>setTab('tasks')}>Default Tasks</button></div>{tab==='workstreams'&&<div style={css.card}><div style={{display:'flex',justifyContent:'space-between',marginBottom:'16px'}}><h3 style={{color:theme.accent}}>Workstreams</h3><button style={{...css.btn,...css.btnSuccess}} onClick={()=>setShowAddWs(true)}>+ Add</button></div><table style={{width:'100%',borderCollapse:'collapse'}}><thead><tr>{['Name','Color','Status','Actions'].map(h=><th key={h} style={{textAlign:'left',padding:'10px',fontSize:'12px',color:theme.accent,borderBottom:'2px solid '+theme.cardBorder}}>{h}</th>)}</tr></thead><tbody>{workstreams.map(ws=><tr key={ws.id} style={{borderBottom:'1px solid '+theme.cardBorder}}><td style={{padding:'12px',color:theme.text}}><span style={{display:'inline-flex',alignItems:'center',gap:'8px'}}><span style={{width:'16px',height:'16px',borderRadius:'4px',background:ws.color}}/>{ws.name}</span></td><td style={{padding:'12px',color:theme.textMuted}}>{ws.color}</td><td style={{padding:'12px'}}><Badge text={ws.active?'Active':'Inactive'} colors={ws.active?theme.status.Complete:theme.status.Blocked}/></td><td style={{padding:'12px'}}><button style={{...css.btn,...css.btnDanger,padding:'4px 10px',fontSize:'11px'}} onClick={async()=>{if(confirm('Delete?')){await api.del('/api/admin/workstreams/'+ws.id);load()}}}>Delete</button></td></tr>)}</tbody></table></div>}{tab==='tasks'&&<div style={css.card}><h3 style={{color:theme.accent,marginBottom:'16px'}}>Default Tasks</h3><table style={{width:'100%',borderCollapse:'collapse'}}><thead><tr>{['ID','Workstream','Name','Priority'].map(h=><th key={h} style={{textAlign:'left',padding:'10px',fontSize:'12px',color:theme.accent,borderBottom:'2px solid '+theme.cardBorder}}>{h}</th>)}</tr></thead><tbody>{tasks.map(t=><tr key={t.id} style={{borderBottom:'1px solid '+theme.cardBorder}}><td style={{padding:'12px',color:theme.teal,fontWeight:'600'}}>{t.id}</td><td style={{padding:'12px',color:theme.text}}>{t.workstream}</td><td style={{padding:'12px',color:theme.text}}>{t.name}</td><td style={{padding:'12px'}}><Badge text={t.priority} colors={theme.priority[t.priority]}/></td></tr>)}</tbody></table></div>}{showAddWs&&<div style={css.modal} onClick={()=>setShowAddWs(false)}><div style={css.modalBox} onClick={e=>e.stopPropagation()}><h2 style={{color:theme.accent,marginBottom:'20px'}}>Add Workstream</h2><div style={{marginBottom:'14px'}}><label style={css.label}>Name *</label><input style={css.input} value={wsForm.name} onChange={e=>setWsForm({...wsForm,name:e.target.value})}/></div><div style={{marginBottom:'20px'}}><label style={css.label}>Color</label><input type="color" style={{...css.input,height:'50px'}} value={wsForm.color} onChange={e=>setWsForm({...wsForm,color:e.target.value})}/></div><div style={{display:'flex',gap:'12px',justifyContent:'flex-end'}}><button style={{...css.btn,...css.btnSec}} onClick={()=>setShowAddWs(false)}>Cancel</button><button style={{...css.btn,...css.btnPri}} onClick={async()=>{if(!wsForm.name)return;await api.post('/api/admin/workstreams',wsForm);setWsForm({name:'',color:'#718096'});setShowAddWs(false);load()}}>Add</button></div></div></div>}</div>}

function ProjectList({onSelect}){const{theme}=useTheme();const css=getCSS(theme);const{permissions}=useAuth();const [projects,setProjects]=useState([]);const [showNew,setShowNew]=useState(false);const [form,setForm]=useState({name:'',description:'',acquired_company:'',parent_company:'Applied Industrial Technologies',start_date:'',target_completion:''});const [loading,setLoading]=useState(true);useEffect(()=>{load()},[]);const load=()=>api.get('/api/projects').then(p=>{setProjects(p);setLoading(false)});if(loading)return<div style={{display:'flex',alignItems:'center',justifyContent:'center',minHeight:'60vh',fontSize:'40px'}}>â³</div>;return <div style={{padding:'20px 32px',maxWidth:'1400px',margin:'0 auto'}}><div style={{display:'flex',justifyContent:'space-between',marginBottom:'24px'}}><div><h1 style={{fontSize:'28px',color:theme.accent}}>M&A Integration Projects</h1><p style={{color:theme.textMuted}}>Select a project or create new</p></div>{permissions.canAdmin&&<button style={{...css.btn,...css.btnPri}} onClick={()=>setShowNew(true)}>+ New Project</button>}</div><div style={{display:'grid',gridTemplateColumns:'repeat(auto-fill,minmax(350px,1fr))',gap:'20px'}}>{projects.map(p=>{const prog=Math.round(p.overall_progress||0);return<div key={p.id} onClick={()=>onSelect(p)} style={{...css.card,cursor:'pointer',borderLeft:'4px solid '+(prog===100?theme.status.Complete.text:theme.accent),position:'relative'}}><div style={{display:'flex',justifyContent:'space-between',marginBottom:'12px'}}><div><div style={{fontSize:'18px',fontWeight:'700',color:theme.accent}}>{p.name}</div><div style={{fontSize:'13px',color:theme.teal}}>{p.acquired_company||'Acquired'} â†’ {p.parent_company||'Applied'}</div></div><Badge text={p.status||'Active'} colors={p.status==='Complete'?theme.status.Complete:theme.status['In Progress']}/></div>{p.description&&<p style={{fontSize:'13px',color:theme.textMuted,marginBottom:'12px'}}>{p.description}</p>}<div><div style={{display:'flex',justifyContent:'space-between',marginBottom:'6px',fontSize:'12px'}}><span style={{color:theme.textMuted}}>Progress</span><span style={{color:theme.accent,fontWeight:'600'}}>{p.completed_count||0}/{p.task_count||0} ({prog}%)</span></div><Progress value={prog}/></div>{permissions.canAdmin&&<button onClick={e=>{e.stopPropagation();if(confirm('Delete?')){api.del('/api/projects/'+p.id);load()}}} style={{position:'absolute',top:'12px',right:'12px',background:'none',border:'none',color:'#f87171',cursor:'pointer',fontSize:'18px'}}>Ã—</button>}</div>})}{projects.length===0&&<div style={{...css.card,textAlign:'center',padding:'60px'}}><div style={{fontSize:'48px',marginBottom:'16px'}}>ğŸ“</div><div style={{color:theme.textMuted}}>No projects yet</div></div>}</div>{showNew&&<div style={css.modal} onClick={()=>setShowNew(false)}><div style={css.modalBox} onClick={e=>e.stopPropagation()}><h2 style={{color:theme.accent,marginBottom:'20px'}}>Create Project</h2><div style={{marginBottom:'14px'}}><label style={css.label}>Name *</label><input style={css.input} value={form.name} onChange={e=>setForm({...form,name:e.target.value})}/></div><div style={{marginBottom:'14px'}}><label style={css.label}>Description</label><textarea style={{...css.input,minHeight:'60px'}} value={form.description} onChange={e=>setForm({...form,description:e.target.value})}/></div><div style={{display:'grid',gridTemplateColumns:'1fr 1fr',gap:'12px',marginBottom:'14px'}}><div><label style={css.label}>Acquired Company</label><input style={css.input} value={form.acquired_company} onChange={e=>setForm({...form,acquired_company:e.target.value})}/></div><div><label style={css.label}>Parent Company</label><input style={css.input} value={form.parent_company} onChange={e=>setForm({...form,parent_company:e.target.value})}/></div><div><label style={css.label}>Start Date</label><input type="date" style={css.input} value={form.start_date} onChange={e=>setForm({...form,start_date:e.target.value})}/></div><div><label style={css.label}>Target Completion</label><input type="date" style={css.input} value={form.target_completion} onChange={e=>setForm({...form,target_completion:e.target.value})}/></div></div><div style={{display:'flex',gap:'12px',justifyContent:'flex-end'}}><button style={{...css.btn,...css.btnSec}} onClick={()=>setShowNew(false)}>Cancel</button><button style={{...css.btn,...css.btnPri}} onClick={async()=>{if(!form.name.trim())return alert('Name required');await api.post('/api/projects',form);setForm({name:'',description:'',acquired_company:'',parent_company:'Applied Industrial Technologies',start_date:'',target_completion:''});setShowNew(false);load()}}>Create</button></div></div></div>}</div>}

function TaskModal({task,projectId,workstreams,usersList,onSave,onClose,canEdit,isNew}){const{theme}=useTheme();const css=getCSS(theme);const [f,setF]=useState(isNew?{id:'',workstream:workstreams[0]||'Custom',name:'',description:'',owner:'',priority:'Medium',status:'Not Started',start_date:'',due_date:'',percent_complete:0,dependencies:'',notes:''}:{...task});const [attachments,setAttachments]=useState([]);const [uploading,setUploading]=useState(false);useEffect(()=>{if(!isNew&&task?.id)loadAtt()},[task]);const loadAtt=()=>api.get('/api/projects/'+projectId+'/tasks/'+task.id+'/attachments').then(setAttachments);const save=()=>{if(!f.id?.trim())return alert('Task ID required');if(!f.name?.trim())return alert('Name required');onSave(f)};const upload=async e=>{const file=e.target.files[0];if(!file)return;setUploading(true);await api.upload('/api/projects/'+projectId+'/tasks/'+task.id+'/attachments',file);loadAtt();setUploading(false);e.target.value=''};const delAtt=async id=>{if(confirm('Delete?')){await api.del('/api/projects/'+projectId+'/tasks/'+task.id+'/attachments/'+id);loadAtt()}};return <div style={css.modal} onClick={onClose}><div style={{...css.modalBox,maxWidth:'750px'}} onClick={e=>e.stopPropagation()}><h2 style={{color:theme.accent,marginBottom:'20px'}}>{isNew?'Add Task':(canEdit?'Edit':'View')+': '+f.id}</h2>{isNew&&<div style={{display:'grid',gridTemplateColumns:'1fr 1fr',gap:'12px',marginBottom:'14px'}}><div><label style={css.label}>Task ID *</label><input style={css.input} value={f.id} onChange={e=>setF({...f,id:e.target.value.toUpperCase()})}/></div><div><label style={css.label}>Workstream</label><select style={{...css.select,width:'100%'}} value={f.workstream} onChange={e=>setF({...f,workstream:e.target.value})}>{workstreams.map(w=><option key={w}>{w}</option>)}<option>Custom</option></select></div></div>}<div style={{marginBottom:'14px'}}><label style={css.label}>Name *</label><input style={css.input} value={f.name} onChange={e=>setF({...f,name:e.target.value})} disabled={!canEdit&&!isNew}/></div><div style={{marginBottom:'14px'}}><label style={css.label}>Description</label><textarea style={{...css.input,minHeight:'60px'}} value={f.description||''} onChange={e=>setF({...f,description:e.target.value})} disabled={!canEdit&&!isNew}/></div><div style={{display:'grid',gridTemplateColumns:'1fr 1fr',gap:'12px'}}><div style={{marginBottom:'14px'}}><label style={css.label}>Owner</label><select style={{...css.select,width:'100%'}} value={f.owner||''} onChange={e=>setF({...f,owner:e.target.value})} disabled={!canEdit&&!isNew}><option value="">-- Unassigned --</option>{usersList.map(u=><option key={u.id} value={u.display_name||u.username}>{u.display_name||u.username} ({u.role})</option>)}</select></div><div style={{marginBottom:'14px'}}><label style={css.label}>Status</label><select style={{...css.select,width:'100%'}} value={f.status} onChange={e=>setF({...f,status:e.target.value})} disabled={!canEdit&&!isNew}><option>Not Started</option><option>In Progress</option><option>Complete</option><option>Blocked</option><option>On Hold</option></select></div><div style={{marginBottom:'14px'}}><label style={css.label}>Priority</label><select style={{...css.select,width:'100%'}} value={f.priority} onChange={e=>setF({...f,priority:e.target.value})} disabled={!canEdit&&!isNew}><option>Critical</option><option>High</option><option>Medium</option><option>Low</option></select></div><div style={{marginBottom:'14px'}}><label style={css.label}>% Complete</label><input type="number" min="0" max="100" style={css.input} value={f.percent_complete||0} onChange={e=>setF({...f,percent_complete:parseInt(e.target.value)||0})} disabled={!canEdit&&!isNew}/></div><div style={{marginBottom:'14px'}}><label style={css.label}>Start Date</label><input type="date" style={css.input} value={f.start_date||''} onChange={e=>setF({...f,start_date:e.target.value})} disabled={!canEdit&&!isNew}/></div><div style={{marginBottom:'14px'}}><label style={css.label}>Due Date</label><input type="date" style={css.input} value={f.due_date||''} onChange={e=>setF({...f,due_date:e.target.value})} disabled={!canEdit&&!isNew}/></div></div><div style={{marginBottom:'14px'}}><label style={css.label}>Dependencies</label><input style={css.input} value={f.dependencies||''} onChange={e=>setF({...f,dependencies:e.target.value})} disabled={!canEdit&&!isNew}/></div><div style={{marginBottom:'14px'}}><label style={css.label}>Notes</label><textarea style={{...css.input,minHeight:'60px'}} value={f.notes||''} onChange={e=>setF({...f,notes:e.target.value})} disabled={!canEdit&&!isNew}/></div>{!isNew&&<div style={{marginBottom:'14px',padding:'16px',background:theme.bgAlt,borderRadius:'8px',border:'1px solid '+theme.cardBorder}}><div style={{display:'flex',justifyContent:'space-between',alignItems:'center',marginBottom:'12px'}}><label style={{...css.label,marginBottom:0}}>ğŸ“ Attachments ({attachments.length})</label>{canEdit&&<label style={{...css.btn,...css.btnSuccess,padding:'6px 14px',fontSize:'12px',cursor:'pointer'}}>{uploading?'Uploading...':'+ Upload'}<input type="file" style={{display:'none'}} onChange={upload} disabled={uploading}/></label>}</div>{attachments.length>0?<div style={{display:'flex',flexDirection:'column',gap:'8px'}}>{attachments.map(a=><div key={a.id} style={{display:'flex',justifyContent:'space-between',alignItems:'center',padding:'10px 14px',background:theme.card,borderRadius:'8px',border:'1px solid '+theme.cardBorder}}><a href={'/uploads/'+a.filename} target="_blank" style={{color:theme.accent,textDecoration:'none',fontSize:'13px'}}>ğŸ“ {a.original_name}</a><div style={{display:'flex',alignItems:'center',gap:'12px'}}><span style={{fontSize:'11px',color:theme.textMuted}}>{Math.round(a.file_size/1024)} KB</span>{canEdit&&<button style={{background:'none',border:'none',color:'#f87171',cursor:'pointer',fontSize:'16px'}} onClick={()=>delAtt(a.id)}>Ã—</button>}</div></div>)}</div>:<div style={{color:theme.textMuted,fontSize:'13px',textAlign:'center',padding:'20px'}}>No attachments</div>}</div>}<div style={{display:'flex',gap:'12px',justifyContent:'flex-end',marginTop:'20px'}}><button style={{...css.btn,...css.btnSec}} onClick={onClose}>{canEdit||isNew?'Cancel':'Close'}</button>{(canEdit||isNew)&&<button style={{...css.btn,...css.btnPri}} onClick={save}>{isNew?'Add':'Save'}</button>}</div></div></div>}

function Dashboard({tasks}){const{theme}=useTheme();const css=getCSS(theme);const stats={total:tasks.length,notStarted:tasks.filter(t=>t.status==='Not Started').length,inProgress:tasks.filter(t=>t.status==='In Progress').length,complete:tasks.filter(t=>t.status==='Complete').length,blocked:tasks.filter(t=>t.status==='Blocked').length};const prog=tasks.length?Math.round(tasks.reduce((s,t)=>s+(t.percent_complete||0),0)/tasks.length):0;const wsList=[...new Set(tasks.map(t=>t.workstream))].map(ws=>{const wt=tasks.filter(t=>t.workstream===ws);return{name:ws,total:wt.length,complete:wt.filter(t=>t.status==='Complete').length,progress:wt.length?Math.round(wt.reduce((s,t)=>s+(t.percent_complete||0),0)/wt.length):0}});const overdue=tasks.filter(t=>t.due_date&&t.due_date<new Date().toISOString().split('T')[0]&&t.status!=='Complete');const critical=tasks.filter(t=>t.priority==='Critical'&&t.status!=='Complete');const blocked=tasks.filter(t=>t.status==='Blocked');return <div><div style={{display:'grid',gridTemplateColumns:'repeat(auto-fit,minmax(140px,1fr))',gap:'16px',marginBottom:'24px'}}>{[{v:stats.total,l:'Total',c:theme.accent,i:'ğŸ“‹'},{v:stats.notStarted,l:'Not Started',c:theme.textMuted,i:'â¸ï¸'},{v:stats.inProgress,l:'In Progress',c:theme.status['In Progress'].text,i:'ğŸ”„'},{v:stats.complete,l:'Complete',c:theme.status.Complete.text,i:'âœ…'},{v:stats.blocked,l:'Blocked',c:theme.status.Blocked.text,i:'ğŸš«'},{v:prog+'%',l:'Progress',c:theme.teal,i:'ğŸ“Š'}].map((s,i)=><div key={i} style={css.card}><div style={{display:'flex',alignItems:'center',gap:'12px'}}><span style={{fontSize:'24px'}}>{s.i}</span><div><div style={{fontSize:'28px',fontWeight:'700',color:s.c}}>{s.v}</div><div style={{fontSize:'11px',color:theme.textMuted,textTransform:'uppercase'}}>{s.l}</div></div></div></div>)}</div><div style={{display:'grid',gridTemplateColumns:'1fr 1fr',gap:'20px'}}><div style={css.card}><div style={{fontWeight:'700',color:theme.accent,marginBottom:'16px'}}>ğŸ“ˆ By Workstream</div>{wsList.map(ws=><div key={ws.name} style={{marginBottom:'14px'}}><div style={{display:'flex',justifyContent:'space-between',marginBottom:'6px',fontSize:'13px'}}><span style={{display:'flex',alignItems:'center',gap:'8px'}}><span style={{width:'10px',height:'10px',borderRadius:'3px',background:wsColors[ws.name]||'#718096'}}/><span style={{color:theme.text}}>{ws.name}</span></span><span style={{fontWeight:'600',color:theme.text}}>{ws.complete}/{ws.total}</span></div><Progress value={ws.progress} color={wsColors[ws.name]}/></div>)}</div><div style={css.card}><div style={{fontWeight:'700',color:theme.accent,marginBottom:'16px'}}>ğŸš¨ Attention</div>{overdue.length>0&&<div style={{marginBottom:'16px'}}><div style={{fontSize:'11px',color:theme.overdueText,marginBottom:'8px',fontWeight:'700'}}>OVERDUE ({overdue.length})</div>{overdue.slice(0,3).map(t=><div key={t.id} style={{padding:'8px 12px',background:theme.overdueBg,borderRadius:'6px',marginBottom:'6px',fontSize:'13px',borderLeft:'3px solid '+theme.overdueText}}><span style={{color:theme.teal,fontWeight:'600'}}>{t.id}</span> <span style={{color:theme.text}}>{t.name}</span></div>)}</div>}{critical.length>0&&<div style={{marginBottom:'16px'}}><div style={{fontSize:'11px',color:theme.priority.Critical.text,marginBottom:'8px',fontWeight:'700'}}>CRITICAL ({critical.length})</div>{critical.slice(0,3).map(t=><div key={t.id} style={{padding:'8px 12px',background:theme.priority.Critical.bg,borderRadius:'6px',marginBottom:'6px',fontSize:'13px',borderLeft:'3px solid '+theme.priority.Critical.text}}><span style={{color:theme.teal,fontWeight:'600'}}>{t.id}</span> <span style={{color:theme.text}}>{t.name}</span></div>)}</div>}{blocked.length>0&&<div><div style={{fontSize:'11px',color:theme.status.Blocked.text,marginBottom:'8px',fontWeight:'700'}}>BLOCKED ({blocked.length})</div>{blocked.slice(0,3).map(t=><div key={t.id} style={{padding:'8px 12px',background:theme.status.Blocked.bg,borderRadius:'6px',marginBottom:'6px',fontSize:'13px',borderLeft:'3px solid '+theme.status.Blocked.text}}><span style={{color:theme.teal,fontWeight:'600'}}>{t.id}</span> <span style={{color:theme.text}}>{t.name}</span></div>)}</div>}{!overdue.length&&!critical.length&&!blocked.length&&<div style={{textAlign:'center',padding:'30px',color:theme.status.Complete.text}}><span style={{fontSize:'40px'}}>âœ“</span><div style={{marginTop:'8px',fontWeight:'600'}}>All clear!</div></div>}</div></div></div>}

function Tasks({tasks,workstreams,projectId,usersList,onUpdate,onAdd,onDelete}){const{theme}=useTheme();const css=getCSS(theme);const{permissions}=useAuth();const [filter,setFilter]=useState({ws:'All',status:'All',search:''});const [sortBy,setSortBy]=useState('id');const [sortDir,setSortDir]=useState('asc');const [editing,setEditing]=useState(null);const [showAdd,setShowAdd]=useState(false);const wsList=['All',...new Set(tasks.map(t=>t.workstream))];const statuses=['All','Not Started','In Progress','Complete','Blocked','On Hold'];const priorityOrder={Critical:0,High:1,Medium:2,Low:3};const filtered=tasks.filter(t=>(filter.ws==='All'||t.workstream===filter.ws)&&(filter.status==='All'||t.status===filter.status)&&(!filter.search||t.name.toLowerCase().includes(filter.search.toLowerCase())||t.id.toLowerCase().includes(filter.search.toLowerCase())));const sorted=[...filtered].sort((a,b)=>{let cmp=0;if(sortBy==='id')cmp=a.id.localeCompare(b.id);else if(sortBy==='due_date')cmp=(a.due_date||'9999').localeCompare(b.due_date||'9999');else if(sortBy==='priority')cmp=(priorityOrder[a.priority]??99)-(priorityOrder[b.priority]??99);else if(sortBy==='workstream')cmp=a.workstream.localeCompare(b.workstream);return sortDir==='asc'?cmp:-cmp});const toggleSort=(col)=>{if(sortBy===col)setSortDir(sortDir==='asc'?'desc':'asc');else{setSortBy(col);setSortDir('asc')}};return <div><div style={css.card}><div style={{display:'flex',gap:'12px',flexWrap:'wrap',alignItems:'center'}}><input style={{...css.input,width:'200px'}} placeholder="ğŸ” Search..." value={filter.search} onChange={e=>setFilter({...filter,search:e.target.value})}/><select style={css.select} value={filter.ws} onChange={e=>setFilter({...filter,ws:e.target.value})}>{wsList.map(w=><option key={w}>{w}</option>)}</select><select style={css.select} value={filter.status} onChange={e=>setFilter({...filter,status:e.target.value})}>{statuses.map(s=><option key={s}>{s}</option>)}</select><div style={{display:'flex',alignItems:'center',gap:'6px'}}><span style={{fontSize:'12px',color:theme.textMuted}}>Sort:</span><select style={css.select} value={sortBy} onChange={e=>setSortBy(e.target.value)}><option value="id">ID</option><option value="due_date">Due Date</option><option value="priority">Priority</option><option value="workstream">Workstream</option></select><button style={{...css.btn,...css.btnSec,padding:'6px 10px',fontSize:'12px'}} onClick={()=>setSortDir(sortDir==='asc'?'desc':'asc')}>{sortDir==='asc'?'â†‘':'â†“'}</button></div><span style={{color:theme.textMuted,fontSize:'13px'}}>{sorted.length} tasks</span><div style={{marginLeft:'auto'}}>{permissions.canAddTasks&&<button style={{...css.btn,...css.btnSuccess}} onClick={()=>setShowAdd(true)}>+ Add Task</button>}</div></div></div><div style={css.card}><table style={{width:'100%',borderCollapse:'collapse'}}><thead><tr>{[{k:'id',l:'ID'},{k:'workstream',l:'Workstream'},{k:'',l:'Task'},{k:'',l:'Owner'},{k:'priority',l:'Priority'},{k:'',l:'Status'},{k:'',l:'Progress'},{k:'due_date',l:'Due'},{k:'',l:'ğŸ“'},{k:'',l:'Actions'}].map((h,i)=><th key={i} style={{textAlign:'left',padding:'12px',fontSize:'11px',color:theme.accent,borderBottom:'2px solid '+theme.cardBorder,cursor:h.k?'pointer':'default'}} onClick={()=>h.k&&toggleSort(h.k)}>{h.l}{sortBy===h.k&&<span style={{marginLeft:'4px'}}>{sortDir==='asc'?'â–²':'â–¼'}</span>}</th>)}</tr></thead><tbody>{sorted.map(t=><tr key={t.id} style={{borderBottom:'1px solid '+theme.cardBorder,background:t.due_date&&t.due_date<new Date().toISOString().split('T')[0]&&t.status!=='Complete'?theme.overdueBg:'transparent'}}><td style={{padding:'12px',color:theme.teal,fontWeight:'600'}}>{t.id}</td><td style={{padding:'12px'}}><span style={{display:'flex',alignItems:'center',gap:'6px'}}><span style={{width:'8px',height:'8px',borderRadius:'2px',background:wsColors[t.workstream]||'#718096'}}/><span style={{color:theme.text}}>{t.workstream}</span></span></td><td style={{padding:'12px',maxWidth:'220px',color:theme.text}}>{t.name}</td><td style={{padding:'12px',color:t.owner?theme.text:theme.textMuted}}>{t.owner||'â€”'}</td><td style={{padding:'12px'}}><Badge text={t.priority} colors={theme.priority[t.priority]}/></td><td style={{padding:'12px'}}>{permissions.canEdit?<select style={{...css.select,padding:'6px 10px',fontSize:'11px',background:theme.status[t.status]?.bg,color:theme.status[t.status]?.text}} value={t.status} onChange={e=>{const updated={...t,status:e.target.value,percent_complete:e.target.value==='Complete'?100:t.percent_complete};onUpdate(updated)}}>{statuses.filter(s=>s!=='All').map(s=><option key={s}>{s}</option>)}</select>:<Badge text={t.status} colors={theme.status[t.status]}/>}</td><td style={{padding:'12px',width:'100px'}}><div style={{display:'flex',alignItems:'center',gap:'8px'}}><Progress value={t.percent_complete||0} color={theme.teal}/><span style={{fontSize:'12px',color:theme.textMuted}}>{t.percent_complete||0}%</span></div></td><td style={{padding:'12px',fontSize:'12px',color:t.due_date&&t.due_date<new Date().toISOString().split('T')[0]&&t.status!=='Complete'?theme.overdueText:theme.textMuted}}>{t.due_date||'â€”'}</td><td style={{padding:'12px',textAlign:'center'}}>{t.attachment_count>0&&<span style={{background:theme.status['In Progress'].bg,color:theme.status['In Progress'].text,padding:'2px 8px',borderRadius:'10px',fontSize:'11px'}}>{t.attachment_count}</span>}</td><td style={{padding:'12px'}}><button style={{...css.btn,...css.btnSec,padding:'6px 12px',fontSize:'11px',marginRight:'6px'}} onClick={()=>setEditing(t)}>{permissions.canEdit?'Edit':'View'}</button>{permissions.canAddTasks&&<button style={{...css.btn,...css.btnDanger,padding:'6px 12px',fontSize:'11px'}} onClick={()=>{if(confirm('Delete '+t.id+'?'))onDelete(t.id)}}>Ã—</button>}</td></tr>)}</tbody></table></div>{editing&&<TaskModal task={editing} projectId={projectId} workstreams={workstreams} usersList={usersList} canEdit={permissions.canEdit} onSave={t=>{onUpdate(t);setEditing(null)}} onClose={()=>setEditing(null)}/>}{showAdd&&<TaskModal isNew projectId={projectId} workstreams={workstreams} usersList={usersList} canEdit onSave={t=>{onAdd(t);setShowAdd(false)}} onClose={()=>setShowAdd(false)}/>}</div>}

function Contacts({contacts,onUpdate}){const{theme}=useTheme();const css=getCSS(theme);const{permissions}=useAuth();const [editId,setEditId]=useState(null);const [form,setForm]=useState({});const byWs={};contacts.forEach(c=>{if(!byWs[c.workstream])byWs[c.workstream]=[];byWs[c.workstream].push(c)});return <div>{Object.entries(byWs).map(([ws,list])=><div key={ws} style={css.card}><div style={{fontWeight:'700',color:theme.accent,marginBottom:'14px',display:'flex',alignItems:'center',gap:'8px'}}><span style={{width:'12px',height:'12px',borderRadius:'3px',background:wsColors[ws]||'#718096'}}/>{ws}</div><div style={{display:'grid',gridTemplateColumns:'repeat(auto-fill,minmax(280px,1fr))',gap:'12px'}}>{list.map(c=><div key={c.id} style={{padding:'16px',background:theme.bgAlt,borderRadius:'8px',border:'1px solid '+theme.cardBorder}}>{editId===c.id&&permissions.canEdit?<div><input style={{...css.input,marginBottom:'8px'}} placeholder="Name" value={form.name||''} onChange={e=>setForm({...form,name:e.target.value})}/><input style={{...css.input,marginBottom:'8px'}} placeholder="Email" value={form.email||''} onChange={e=>setForm({...form,email:e.target.value})}/><input style={{...css.input,marginBottom:'8px'}} placeholder="Phone" value={form.phone||''} onChange={e=>setForm({...form,phone:e.target.value})}/><div style={{display:'flex',gap:'8px'}}><button style={{...css.btn,...css.btnPri,flex:1,padding:'8px'}} onClick={()=>{onUpdate(form);setEditId(null)}}>Save</button><button style={{...css.btn,...css.btnSec,padding:'8px'}} onClick={()=>setEditId(null)}>Cancel</button></div></div>:<div><div style={{display:'flex',justifyContent:'space-between'}}><div><div style={{fontWeight:'600',color:theme.text}}>{c.name||<span style={{color:theme.textMuted}}>No name</span>}</div><div style={{fontSize:'12px',color:theme.teal}}>{c.role}</div></div>{permissions.canEdit&&<button style={{background:'none',border:'none',color:theme.accent,cursor:'pointer',fontSize:'12px'}} onClick={()=>{setEditId(c.id);setForm({...c})}}>Edit</button>}</div><div style={{marginTop:'12px',fontSize:'12px',color:theme.textMuted}}>ğŸ“§ {c.email||'â€”'}<br/>ğŸ“± {c.phone||'â€”'}</div></div>}</div>)}</div></div>)}</div>}

function Risks({risks}){const{theme}=useTheme();const css=getCSS(theme);const score=(l,i)=>({High:3,Medium:2,Low:1}[l]||0)*({High:3,Medium:2,Low:1}[i]||0);const sorted=[...risks].sort((a,b)=>score(b.likelihood,b.impact)-score(a.likelihood,a.impact));const getColor=(s)=>s>=6?theme.priority.Critical.text:s>=4?theme.priority.High.text:theme.priority.Medium.text;const getBg=(s)=>s>=6?theme.priority.Critical.bg:s>=4?theme.priority.High.bg:theme.priority.Medium.bg;return <div><div style={css.card}><div style={{fontWeight:'700',color:theme.accent}}>âš ï¸ Risk Register</div></div>{sorted.map(r=>{const s=score(r.likelihood,r.impact);const col=getColor(s);return<div key={r.id} style={{...css.card,borderLeft:'4px solid '+col}}><div style={{display:'flex',justifyContent:'space-between',marginBottom:'10px'}}><span style={{fontWeight:'700',color:col}}>{r.id}</span><span style={{padding:'4px 12px',background:getBg(s),borderRadius:'6px',fontSize:'13px',fontWeight:'600',color:col}}>Score: {s}</span></div><div style={{marginBottom:'10px',color:theme.text}}>{r.description}</div><div style={{padding:'12px',background:theme.status['In Progress'].bg,borderRadius:'6px',borderLeft:'3px solid '+theme.status['In Progress'].text}}><div style={{fontSize:'11px',color:theme.status['In Progress'].text,fontWeight:'700',marginBottom:'4px'}}>MITIGATION</div><div style={{fontSize:'13px',color:theme.text}}>{r.mitigation}</div></div></div>})}</div>}

function ProjectView({project,onBack}){const{theme}=useTheme();const css=getCSS(theme);const{user,permissions}=useAuth();const [tasks,setTasks]=useState([]);const [contacts,setContacts]=useState([]);const [risks,setRisks]=useState([]);const [usersList,setUsersList]=useState([]);const [tab,setTab]=useState('dashboard');const [loading,setLoading]=useState(true);const [saving,setSaving]=useState(false);useEffect(()=>{Promise.all([api.get('/api/projects/'+project.id+'/tasks'),api.get('/api/projects/'+project.id+'/contacts'),api.get('/api/projects/'+project.id+'/risks'),api.get('/api/users/list')]).then(([t,c,r,u])=>{setTasks(t);setContacts(c);setRisks(r);setUsersList(u);setLoading(false)})},[project.id]);const workstreams=[...new Set(tasks.map(t=>t.workstream))];const updateTask=async t=>{setSaving(true);await api.put('/api/projects/'+project.id+'/tasks/'+t.id,t);setTasks(tasks.map(x=>x.id===t.id?t:x));setSaving(false)};const addTask=async t=>{setSaving(true);await api.post('/api/projects/'+project.id+'/tasks',t);setTasks([...tasks,t]);setSaving(false)};const deleteTask=async id=>{setSaving(true);await api.del('/api/projects/'+project.id+'/tasks/'+id);setTasks(tasks.filter(t=>t.id!==id));setSaving(false)};const updateContact=async c=>{setSaving(true);await api.put('/api/projects/'+project.id+'/contacts/'+c.id,c);setContacts(contacts.map(x=>x.id===c.id?c:x));setSaving(false)};const handleExport=async()=>{const data=await api.get('/api/projects/'+project.id+'/export');exportToExcel(data)};if(loading)return<div style={{display:'flex',alignItems:'center',justifyContent:'center',minHeight:'60vh',fontSize:'40px'}}>â³</div>;const tabs=[{id:'dashboard',label:'Dashboard',icon:'ğŸ“Š'},{id:'tasks',label:'Tasks',icon:'ğŸ“‹'},{id:'contacts',label:'Contacts',icon:'ğŸ‘¥'},{id:'risks',label:'Risks',icon:'âš ï¸'}];return <div><header style={css.header}><div style={{maxWidth:'1600px',margin:'0 auto',display:'flex',justifyContent:'space-between',alignItems:'center'}}><div style={{display:'flex',alignItems:'center',gap:'16px'}}><button onClick={onBack} style={{...css.btn,...css.btnSec,padding:'8px 12px'}}>â† Back</button><div><div style={{fontSize:'18px',fontWeight:'700',color:theme.accent}}>{project.name}</div><div style={{fontSize:'12px',color:theme.teal}}>{project.acquired_company} â†’ {project.parent_company}</div></div></div><div style={{display:'flex',alignItems:'center',gap:'12px'}}><ThemeToggle/><button style={{...css.btn,...css.btnSec,padding:'8px 14px',fontSize:'12px'}} onClick={handleExport}>ğŸ“¥ Export</button><Badge text={user.role} colors={theme.role[user.role]}/><span style={{fontSize:'12px',color:theme.textMuted}}>{saving?'Saving...':'âœ“ Synced'}</span></div></div></header><nav style={{display:'flex',gap:'4px',padding:'8px',background:theme.card,borderRadius:'12px',margin:'20px 32px 0',maxWidth:'1600px',marginLeft:'auto',marginRight:'auto',border:'1px solid '+theme.cardBorder}}>{tabs.map(t=><button key={t.id} style={{...css.btn,...(tab===t.id?css.btnPri:{background:'transparent',color:theme.textMuted}),display:'flex',alignItems:'center',gap:'6px'}} onClick={()=>setTab(t.id)}>{t.icon} {t.label}</button>)}</nav><main style={{padding:'20px 32px',maxWidth:'1600px',margin:'0 auto'}}>{tab==='dashboard'&&<Dashboard tasks={tasks}/>}{tab==='tasks'&&<Tasks tasks={tasks} workstreams={workstreams} projectId={project.id} usersList={usersList} onUpdate={updateTask} onAdd={addTask} onDelete={deleteTask}/>}{tab==='contacts'&&<Contacts contacts={contacts} onUpdate={updateContact}/>}{tab==='risks'&&<Risks risks={risks}/>}</main></div>}

function MyTasks(){const{theme}=useTheme();const css=getCSS(theme);const{user,permissions}=useAuth();const [tasks,setTasks]=useState([]);const [loading,setLoading]=useState(true);const [filter,setFilter]=useState('all');useEffect(()=>{api.get('/api/my-tasks').then(t=>{setTasks(t);setLoading(false)})},[]);const updateStatus=async(t,newStatus)=>{const updated={...t,status:newStatus,percent_complete:newStatus==='Complete'?100:t.percent_complete};await api.put('/api/projects/'+t.project_id+'/tasks/'+t.id,updated);setTasks(tasks.map(x=>x.id===t.id&&x.project_id===t.project_id?updated:x))};const today=new Date().toISOString().split('T')[0];const overdue=tasks.filter(t=>t.due_date&&t.due_date<today&&t.status!=='Complete');const inProgress=tasks.filter(t=>t.status==='In Progress');const blocked=tasks.filter(t=>t.status==='Blocked');const notStarted=tasks.filter(t=>t.status==='Not Started');const complete=tasks.filter(t=>t.status==='Complete');const filtered=filter==='all'?tasks:filter==='overdue'?overdue:filter==='blocked'?blocked:filter==='inprogress'?inProgress:filter==='notstarted'?notStarted:complete;const byProject={};filtered.forEach(t=>{if(!byProject[t.project_name])byProject[t.project_name]=[];byProject[t.project_name].push(t)});if(loading)return<div style={{display:'flex',alignItems:'center',justifyContent:'center',minHeight:'60vh',fontSize:'40px'}}>â³</div>;return<div style={{padding:'20px 32px',maxWidth:'1400px',margin:'0 auto'}}><div style={{marginBottom:'24px'}}><h1 style={{fontSize:'28px',color:theme.accent,marginBottom:'8px'}}>ğŸ‘¤ My Tasks</h1><p style={{color:theme.textMuted}}>Tasks assigned to {user.display_name||user.username}</p></div><div style={{display:'grid',gridTemplateColumns:'repeat(auto-fit,minmax(120px,1fr))',gap:'12px',marginBottom:'24px'}}>{[{k:'all',l:'All',v:tasks.length,c:theme.accent},{k:'overdue',l:'Overdue',v:overdue.length,c:theme.overdueText},{k:'blocked',l:'Blocked',v:blocked.length,c:theme.status.Blocked.text},{k:'inprogress',l:'In Progress',v:inProgress.length,c:theme.status['In Progress'].text},{k:'notstarted',l:'Not Started',v:notStarted.length,c:theme.textMuted},{k:'complete',l:'Complete',v:complete.length,c:theme.status.Complete.text}].map(f=><div key={f.k} onClick={()=>setFilter(f.k)} style={{...css.card,cursor:'pointer',borderLeft:'4px solid '+(filter===f.k?f.c:'transparent'),opacity:filter===f.k?1:0.7}}><div style={{fontSize:'24px',fontWeight:'700',color:f.c}}>{f.v}</div><div style={{fontSize:'11px',color:theme.textMuted,textTransform:'uppercase'}}>{f.l}</div></div>)}</div>{Object.keys(byProject).length===0?<div style={{...css.card,textAlign:'center',padding:'60px'}}><div style={{fontSize:'48px',marginBottom:'16px'}}>âœ…</div><div style={{color:theme.textMuted}}>{filter==='all'?'No tasks assigned to you':'No tasks match this filter'}</div></div>:Object.entries(byProject).map(([proj,ptasks])=><div key={proj} style={{marginBottom:'24px'}}><div style={{fontSize:'16px',fontWeight:'700',color:theme.accent,marginBottom:'12px',display:'flex',alignItems:'center',gap:'8px'}}>ğŸ“ {proj}<span style={{fontSize:'12px',color:theme.textMuted,fontWeight:'400'}}>({ptasks.length} tasks)</span></div><div style={css.card}><table style={{width:'100%',borderCollapse:'collapse'}}><thead><tr>{['ID','Workstream','Task','Priority','Status','Due','Progress'].map(h=><th key={h} style={{textAlign:'left',padding:'10px',fontSize:'11px',color:theme.accent,borderBottom:'2px solid '+theme.cardBorder}}>{h}</th>)}</tr></thead><tbody>{ptasks.map(t=><tr key={t.id} style={{borderBottom:'1px solid '+theme.cardBorder,background:t.due_date&&t.due_date<today&&t.status!=='Complete'?theme.overdueBg:'transparent'}}><td style={{padding:'10px',color:theme.teal,fontWeight:'600'}}>{t.id}</td><td style={{padding:'10px'}}><span style={{display:'flex',alignItems:'center',gap:'6px'}}><span style={{width:'8px',height:'8px',borderRadius:'2px',background:wsColors[t.workstream]||'#718096'}}/><span style={{color:theme.text,fontSize:'13px'}}>{t.workstream}</span></span></td><td style={{padding:'10px',color:theme.text,fontSize:'13px'}}>{t.name}</td><td style={{padding:'10px'}}><Badge text={t.priority} colors={theme.priority[t.priority]}/></td><td style={{padding:'10px'}}>{permissions.canEdit?<select style={{...css.select,padding:'4px 8px',fontSize:'11px',background:theme.status[t.status]?.bg,color:theme.status[t.status]?.text}} value={t.status} onChange={e=>updateStatus(t,e.target.value)}><option>Not Started</option><option>In Progress</option><option>Complete</option><option>Blocked</option><option>On Hold</option></select>:<Badge text={t.status} colors={theme.status[t.status]}/>}</td><td style={{padding:'10px',fontSize:'12px',color:t.due_date&&t.due_date<today&&t.status!=='Complete'?theme.overdueText:theme.textMuted,fontWeight:t.due_date&&t.due_date<today&&t.status!=='Complete'?'600':'400'}}>{t.due_date||'â€”'}</td><td style={{padding:'10px',width:'100px'}}><div style={{display:'flex',alignItems:'center',gap:'6px'}}><Progress value={t.percent_complete||0} color={theme.teal}/><span style={{fontSize:'11px',color:theme.textMuted}}>{t.percent_complete||0}%</span></div></td></tr>)}</tbody></table></div></div>)}</div>}

function MainApp(){const{theme}=useTheme();const css=getCSS(theme);const{user,permissions,logout}=useAuth();const [view,setView]=useState('projects');const [selectedProject,setSelectedProject]=useState(null);const [showProfile,setShowProfile]=useState(false);const [pwForm,setPwForm]=useState({current:'',new:'',confirm:''});const [pwMsg,setPwMsg]=useState('');const changePw=async()=>{if(pwForm.new!==pwForm.confirm)return setPwMsg('Passwords do not match');try{const res=await api.post('/api/auth/change-password',{currentPassword:pwForm.current,newPassword:pwForm.new});if(res.error)throw new Error(res.error);setPwMsg('Password changed!');setPwForm({current:'',new:'',confirm:''})}catch(e){setPwMsg(e.message)}};if(selectedProject)return<ProjectView project={selectedProject} onBack={()=>setSelectedProject(null)}/>;return <div><header style={css.header}><div style={{maxWidth:'1600px',margin:'0 auto',display:'flex',justifyContent:'space-between',alignItems:'center'}}><div style={{display:'flex',alignItems:'center',gap:'20px',cursor:'pointer'}} onClick={()=>setView('projects')}><img src="/logo.jpg" style={{height:'40px',filter:theme.name==='dark'?'brightness(1.1)':'none'}}/><div style={{borderLeft:'2px solid '+theme.cardBorder,paddingLeft:'20px'}}><div style={{fontSize:'18px',fontWeight:'700',color:theme.accent}}>IT Integration Tracker</div><div style={{fontSize:'11px',color:theme.teal,textTransform:'uppercase'}}>M&A Technology Integration</div></div></div><div style={{display:'flex',alignItems:'center',gap:'12px'}}><ThemeToggle/><button style={{...css.btn,...(view==='mytasks'?css.btnPri:css.btnSec),padding:'8px 14px',fontSize:'12px'}} onClick={()=>setView('mytasks')}>ğŸ‘¤ My Tasks</button>{permissions.canAdmin&&<><button style={{...css.btn,...css.btnSec,padding:'8px 14px',fontSize:'12px'}} onClick={()=>setView('templates')}>âš™ï¸ Templates</button><button style={{...css.btn,...css.btnSec,padding:'8px 14px',fontSize:'12px'}} onClick={()=>setView('users')}>ğŸ‘¥ Users</button></>}{view!=='projects'&&<button style={{...css.btn,...css.btnPri,padding:'8px 14px',fontSize:'12px'}} onClick={()=>setView('projects')}>â† Projects</button>}<div style={{position:'relative'}}><button onClick={()=>setShowProfile(!showProfile)} style={{display:'flex',alignItems:'center',gap:'10px',background:theme.card,border:'1px solid '+theme.cardBorder,borderRadius:'10px',padding:'10px 16px',cursor:'pointer',color:theme.text}}>{user.display_name||user.username} <Badge text={user.role} colors={theme.role[user.role]}/></button>{showProfile&&<div style={{position:'absolute',top:'100%',right:0,marginTop:'8px',background:theme.card,border:'1px solid '+theme.cardBorder,borderRadius:'12px',padding:'20px',width:'280px',zIndex:100,boxShadow:'0 10px 40px '+theme.shadow}}><div style={{marginBottom:'16px',paddingBottom:'16px',borderBottom:'1px solid '+theme.cardBorder}}><div style={{fontWeight:'600',color:theme.text}}>{user.display_name||user.username}</div><div style={{fontSize:'13px',color:theme.textMuted}}>@{user.username}</div></div><label style={css.label}>Change Password</label><input type="password" placeholder="Current" style={{...css.input,marginBottom:'8px'}} value={pwForm.current} onChange={e=>setPwForm({...pwForm,current:e.target.value})}/><input type="password" placeholder="New" style={{...css.input,marginBottom:'8px'}} value={pwForm.new} onChange={e=>setPwForm({...pwForm,new:e.target.value})}/><input type="password" placeholder="Confirm" style={{...css.input,marginBottom:'12px'}} value={pwForm.confirm} onChange={e=>setPwForm({...pwForm,confirm:e.target.value})}/>{pwMsg&&<div style={{fontSize:'12px',color:pwMsg.includes('changed')?theme.status.Complete.text:theme.status.Blocked.text,marginBottom:'12px'}}>{pwMsg}</div>}<button style={{...css.btn,...css.btnPri,width:'100%',marginBottom:'8px'}} onClick={changePw}>Update</button><button style={{...css.btn,...css.btnDanger,width:'100%'}} onClick={logout}>Sign Out</button></div>}</div></div></div></header>{view==='projects'&&<ProjectList onSelect={setSelectedProject}/>}{view==='mytasks'&&<MyTasks/>}{view==='users'&&permissions.canAdmin&&<UserManagement/>}{view==='templates'&&permissions.canAdmin&&<AdminTemplates/>}</div>}

function App(){const [user,setUser]=useState(null);const [permissions,setPermissions]=useState(null);const [loading,setLoading]=useState(true);const [themeName,setThemeName]=useState(()=>localStorage.getItem('theme')||'light');const theme=themes[themeName];const toggleTheme=()=>{const n=themeName==='light'?'dark':'light';setThemeName(n);localStorage.setItem('theme',n);document.body.className=n};useEffect(()=>{document.body.className=themeName},[themeName]);useEffect(()=>{const token=localStorage.getItem('token');if(token){api.token=token;api.get('/api/auth/me').then(data=>{if(data.user){setUser(data.user);setPermissions(data.permissions)}setLoading(false)}).catch(()=>{localStorage.removeItem('token');setLoading(false)})}else setLoading(false)},[]);if(loading)return<div style={{display:'flex',alignItems:'center',justifyContent:'center',minHeight:'100vh',fontSize:'48px'}}>â³</div>;return<ThemeContext.Provider value={{theme,toggleTheme}}>{!user?<LoginScreen onLogin={u=>{setUser(u);api.get('/api/auth/me').then(d=>setPermissions(d.permissions))}}/>:<AuthContext.Provider value={{user,permissions,logout:()=>{api.post('/api/auth/logout');localStorage.removeItem('token');setUser(null);setPermissions(null)}}}><MainApp/></AuthContext.Provider>}</ThemeContext.Provider>}
ReactDOM.createRoot(document.getElementById('root')).render(<App/>);
</script>
</body>
</html>
